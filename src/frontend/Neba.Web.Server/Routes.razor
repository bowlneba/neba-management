@inject NavigationManager NavigationManager
@inject IWebHostEnvironment HostEnv

<Router AppAssembly="typeof(Program).Assembly" AdditionalAssemblies="new[] { typeof(Client._Imports).Assembly }" NotFoundPage="typeof(Pages.NotFound)">
    <Found Context="routeData">
        <ErrorBoundary>
            <ChildContent>
                @if (IsTestingRoute(routeData) && !IsTestEnvironment)
                {
                    <RouteView RouteData="@CreateNotFoundRouteData()" DefaultLayout="typeof(Layout.MainLayout)" />
                }
                else
                {
                    <RouteView RouteData="routeData" DefaultLayout="typeof(Layout.MainLayout)" />
                }
                <FocusOnNavigate RouteData="routeData" Selector="h1" />
            </ChildContent>
            <ErrorContent Context="ex">
                <article class="px-4 py-6">
                    <h1 class="text-2xl font-semibold mb-2 text-[var(--neba-accent-red)]">Something went wrong</h1>
                    <p class="mb-4 text-[var(--neba-text)]">An unexpected error occurred while rendering this page.</p>
                    <details class="mb-4 text-sm text-[var(--neba-text-muted)]">
                        <summary>Details</summary>
                        <pre class="whitespace-pre-wrap mt-2">@ex.Message</pre>
                    </details>
                    <div class="flex gap-3">
                        <a href="/Error" class="neba-btn neba-btn-secondary">View Error Page</a>
                        <button class="neba-btn neba-btn-primary" @onclick="() => NavigationManager.NavigateTo(NavigationManager.Uri, forceLoad: true)">Refresh</button>
                    </div>
                </article>
            </ErrorContent>
        </ErrorBoundary>
    </Found>
</Router>

@code {
    private bool IsTestEnvironment =>
        HostEnv.EnvironmentName == "Development" ||
        HostEnv.EnvironmentName == "Test";

    private static bool IsTestingRoute(RouteData routeData)
    {
        var pageType = routeData.PageType;
        return pageType.FullName?.Contains("TestHarness") == true ||
               pageType.FullName?.Contains("Testing.Pages") == true;
    }

    private static RouteData CreateNotFoundRouteData()
    {
        return new RouteData(typeof(Pages.NotFound), new Dictionary<string, object?>());
    }
}
