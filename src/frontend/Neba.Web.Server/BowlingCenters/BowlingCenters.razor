@page "/bowling-centers"
@using Neba.Web.Server.Notifications
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<PageTitle>Bowling Centers - NEBA</PageTitle>
<HeadContent>
    <meta name="description" content="Browse USBC certified bowling centers across New England. Find centers in Massachusetts, Connecticut, Rhode Island, New Hampshire, Maine, and Vermont." />
</HeadContent>

<div class="neba-space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-3xl font-bold text-[var(--neba-blue-700)]">Bowling Centers</h1>
        <p class="mt-1 text-sm text-gray-600">USBC certified centers across New England</p>
    </div>

    <!-- Error Alert -->
    @if (!string.IsNullOrWhiteSpace(_errorMessage))
    {
        <NebaAlert Severity="NotifySeverity.Error"
                   Title="Error Loading Centers"
                   Message="@_errorMessage"
                   Dismissible="true"
                   OnDismiss="@(() => _errorMessage = null)" />
    }

    <!-- Loading Indicator -->
    <NebaLoadingIndicator IsVisible="@_isLoading"
                          Text="Loading bowling centers..."
                          Scope="LoadingIndicatorScope.Page" />

    <!-- Filter Bar -->
    @if (!_isLoading && _allCenters.Count > 0)
    {
        <div class="flex flex-col md:flex-row gap-4 p-4 bg-[var(--neba-gray-100)] rounded-lg border border-[var(--neba-gray-300)]">
            <!-- State Filters -->
            <div class="flex flex-wrap items-center gap-2">
                <span class="font-semibold text-[var(--neba-gray-700)] text-sm">Filter by State:</span>
                <button class="state-btn @(_selectedState == "All" ? "active" : "")" @onclick="@(() => FilterByState("All"))">
                    All States
                </button>
                <button class="state-btn @(_selectedState == "MA" ? "active" : "")" @onclick="@(() => FilterByState("MA"))">
                    MA
                </button>
                <button class="state-btn @(_selectedState == "CT" ? "active" : "")" @onclick="@(() => FilterByState("CT"))">
                    CT
                </button>
                <button class="state-btn @(_selectedState == "RI" ? "active" : "")" @onclick="@(() => FilterByState("RI"))">
                    RI
                </button>
                <button class="state-btn @(_selectedState == "NH" ? "active" : "")" @onclick="@(() => FilterByState("NH"))">
                    NH
                </button>
                <button class="state-btn @(_selectedState == "ME" ? "active" : "")" @onclick="@(() => FilterByState("ME"))">
                    ME
                </button>
                <button class="state-btn @(_selectedState == "VT" ? "active" : "")" @onclick="@(() => FilterByState("VT"))">
                    VT
                </button>
            </div>

            <!-- Search Box -->
            <div class="flex-1 min-w-[200px]">
                <input type="text"
                       class="w-full px-4 py-2 border-2 border-[var(--neba-gray-300)] rounded-md focus:outline-none focus:border-[var(--neba-blue-500)] transition-colors"
                       placeholder="Search centers..."
                       @bind="_searchQuery"
                       @bind:event="oninput"
                       @bind:after="ApplyFilters" />
            </div>

            <!-- Results Count -->
            <div class="flex items-center text-sm text-[var(--neba-gray-700)] whitespace-nowrap">
                Showing <span class="font-semibold mx-1">@_filteredCenters.Count</span> centers
            </div>
        </div>
    }

    <!-- Main Content: Side-by-Side Layout -->
    @if (!_isLoading && _allCenters.Count > 0)
    {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-[600px]">
            <!-- Left Side: Centers List -->
            <div class="flex flex-col">
                <div class="overflow-y-auto pr-2 space-y-4" style="max-height: 600px;">
                    @if (_filteredCenters.Count == 0)
                    {
                        <div class="neba-card text-center py-8">
                            <p class="text-[var(--neba-gray-700)]">No centers found matching your search criteria.</p>
                        </div>
                    }
                    else
                    {
                        @foreach (var center in _filteredCenters)
                        {
                            <div class="neba-card hover:shadow-lg hover:border-[var(--neba-blue-500)] transition-all cursor-pointer"
                                 @onclick="@(() => HandleCenterCardClick(center))">
                                <h3 class="text-lg font-bold text-[var(--neba-blue-700)] mb-3">@center.Name</h3>

                                <div class="space-y-2 mb-4">
                                    <!-- Address -->
                                    <div class="flex items-start gap-2 text-sm text-[var(--neba-gray-700)]">
                                        <svg class="w-5 h-5 text-[var(--neba-blue-600)] flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                        </svg>
                                        <div>
                                            @center.Street
                                            @if (!string.IsNullOrWhiteSpace(center.Unit))
                                            {
                                                <br />
                                                @center.Unit
                                            }
                                            <br />
                                            @center.City, @center.State @center.ZipCode
                                        </div>
                                    </div>

                                    <!-- Phone -->
                                    <div class="flex items-center gap-2 text-sm">
                                        <svg class="w-5 h-5 text-[var(--neba-blue-600)] flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                        <a href="@GetPhoneTelUri(center.PhoneNumber)"
                                           class="text-[var(--neba-blue-600)] hover:text-[var(--neba-blue-700)] hover:underline"
                                           @onclick:stopPropagation="true">
                                            @FormatPhoneNumber(center.PhoneNumber)@(!string.IsNullOrWhiteSpace(center.PhoneExtension) ? $" x{center.PhoneExtension}" : "")
                                        </a>
                                    </div>
                                </div>

                                <button class="neba-btn neba-btn-primary w-full flex items-center justify-center gap-2"
                                        @onclick="@((e) => HandleDirectionsClick(center, e))"
                                        @onclick:stopPropagation="true">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                    </svg>
                                    Get Directions
                                </button>
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Right Side: Map Placeholder -->
            <div class="flex flex-col">
                <div class="neba-card flex items-center justify-center bg-gradient-to-br from-[var(--neba-blue-100)] to-[var(--neba-blue-300)] text-[var(--neba-blue-700)]" style="height: 600px;">
                    <div class="text-center">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        <p class="font-semibold text-lg">Azure Maps</p>
                        <p class="text-sm opacity-80 mt-2">Interactive map will be displayed here</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<BowlingCenterViewModel> _allCenters = new();
    private List<BowlingCenterViewModel> _filteredCenters = new();
    private string? _errorMessage;
    private bool _isLoading = true;
    private string _selectedState = "All";
    private string _searchQuery = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Simulate API call with 2500ms delay
            await Task.Delay(2500);

            // Load dummy data
            _allCenters = GetDummyBowlingCenters();
            _filteredCenters = _allCenters;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load bowling centers: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterByState(string state)
    {
        _selectedState = state;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        _filteredCenters = _allCenters
            .Where(c => _selectedState == "All" || c.State == _selectedState)
            .Where(c => string.IsNullOrWhiteSpace(_searchQuery) ||
                       c.Name.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase) ||
                       c.City.Contains(_searchQuery, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private void HandleCenterCardClick(BowlingCenterViewModel center)
    {
        // Placeholder for map focus functionality
        _ = JSInterop.InvokeVoidAsync("alert", $"Would focus map on {center.Name}");
    }

    private void HandleDirectionsClick(BowlingCenterViewModel center, MouseEventArgs e)
    {
        // Placeholder for directions functionality
        _ = JSInterop.InvokeVoidAsync("alert", $"Get directions to {center.Name}");
    }

    private static string GetPhoneTelUri(string phoneNumber)
    {
        // Generate tel: URI with + prefix for international compatibility
        // Assumes phoneNumber already includes country code (e.g., "12035551234")
        return $"tel:+{phoneNumber}";
    }

    private static string FormatPhoneNumber(string phoneNumber)
    {
        // Format North American phone numbers as (NPA) NXX-XXXX
        // Assumes format: 1 (country code) + 10 digits (area code + number)
        if (phoneNumber.Length == 11 && phoneNumber.StartsWith('1'))
        {
            // Strip leading "1" country code for display
            var digits = phoneNumber[1..];
            return $"({digits[..3]}) {digits[3..6]}-{digits[6..]}";
        }

        // If format doesn't match expected, return as-is
        return phoneNumber;
    }

    private static List<BowlingCenterViewModel> GetDummyBowlingCenters()
    {
        return new List<BowlingCenterViewModel>
        {
            new BowlingCenterViewModel(
                Name: "Brunswick Bowl-O-Drome",
                Street: "123 Main Street",
                Unit: null,
                City: "Boston",
                State: "MA",
                ZipCode: "02101",
                PhoneNumber: "16175550100",
                PhoneExtension: null,
                Latitude: 42.3601,
                Longitude: -71.0589),
            new BowlingCenterViewModel(
                Name: "Kings Bowling",
                Street: "456 Oak Avenue",
                Unit: "Suite 200",
                City: "Worcester",
                State: "MA",
                ZipCode: "01608",
                PhoneNumber: "15085550200",
                PhoneExtension: null,
                Latitude: 42.2626,
                Longitude: -71.8023),
            new BowlingCenterViewModel(
                Name: "Strike Zone Entertainment",
                Street: "789 Elm Street",
                Unit: null,
                City: "Springfield",
                State: "MA",
                ZipCode: "01103",
                PhoneNumber: "14135550300",
                PhoneExtension: "123",
                Latitude: 42.1015,
                Longitude: -72.5898),
            new BowlingCenterViewModel(
                Name: "Lucky Lanes",
                Street: "321 Pine Road",
                Unit: null,
                City: "Hartford",
                State: "CT",
                ZipCode: "06103",
                PhoneNumber: "18605550400",
                PhoneExtension: null,
                Latitude: 41.7658,
                Longitude: -72.6734),
            new BowlingCenterViewModel(
                Name: "Spare Time Bowling",
                Street: "654 Maple Drive",
                Unit: null,
                City: "Providence",
                State: "RI",
                ZipCode: "02903",
                PhoneNumber: "14015550500",
                PhoneExtension: null,
                Latitude: 41.8240,
                Longitude: -71.4128),
            new BowlingCenterViewModel(
                Name: "All Star Lanes",
                Street: "987 Cedar Lane",
                Unit: "Unit B",
                City: "Manchester",
                State: "NH",
                ZipCode: "03101",
                PhoneNumber: "16035550600",
                PhoneExtension: "456",
                Latitude: 42.9956,
                Longitude: -71.4548),
            new BowlingCenterViewModel(
                Name: "Perfect Game Lanes",
                Street: "147 Birch Street",
                Unit: null,
                City: "Portland",
                State: "ME",
                ZipCode: "04101",
                PhoneNumber: "12075550700",
                PhoneExtension: null,
                Latitude: 43.6591,
                Longitude: -70.2568),
            new BowlingCenterViewModel(
                Name: "Green Mountain Bowling",
                Street: "258 Spruce Avenue",
                Unit: null,
                City: "Burlington",
                State: "VT",
                ZipCode: "05401",
                PhoneNumber: "18025550800",
                PhoneExtension: null,
                Latitude: 44.4759,
                Longitude: -73.2121),
            new BowlingCenterViewModel(
                Name: "AMF Circle Lanes",
                Street: "369 Willow Court",
                Unit: null,
                City: "New Haven",
                State: "CT",
                ZipCode: "06510",
                PhoneNumber: "12035550900",
                PhoneExtension: null,
                Latitude: 41.3083,
                Longitude: -72.9279),
            new BowlingCenterViewModel(
                Name: "Colonial Lanes",
                Street: "741 Hickory Way",
                Unit: null,
                City: "Cambridge",
                State: "MA",
                ZipCode: "02139",
                PhoneNumber: "16175551000",
                PhoneExtension: null,
                Latitude: 42.3736,
                Longitude: -71.1097),
            new BowlingCenterViewModel(
                Name: "Thunder Alley",
                Street: "852 Ash Boulevard",
                Unit: "Suite 12",
                City: "Warwick",
                State: "RI",
                ZipCode: "02886",
                PhoneNumber: "14015551100",
                PhoneExtension: null,
                Latitude: 41.7001,
                Longitude: -71.4162),
            new BowlingCenterViewModel(
                Name: "Pinz Entertainment",
                Street: "963 Walnut Place",
                Unit: null,
                City: "Nashua",
                State: "NH",
                ZipCode: "03060",
                PhoneNumber: "16035551200",
                PhoneExtension: null,
                Latitude: 42.7654,
                Longitude: -71.4676),
            new BowlingCenterViewModel(
                Name: "Bayside Bowl",
                Street: "159 Cherry Street",
                Unit: null,
                City: "Bangor",
                State: "ME",
                ZipCode: "04401",
                PhoneNumber: "12075551300",
                PhoneExtension: null,
                Latitude: 44.8016,
                Longitude: -68.7712),
            new BowlingCenterViewModel(
                Name: "Champlain Lanes",
                Street: "357 Poplar Drive",
                Unit: null,
                City: "Montpelier",
                State: "VT",
                ZipCode: "05602",
                PhoneNumber: "18025551400",
                PhoneExtension: null,
                Latitude: 44.2601,
                Longitude: -72.5754),
            new BowlingCenterViewModel(
                Name: "Boston Bowl",
                Street: "486 Sycamore Road",
                Unit: null,
                City: "Dorchester",
                State: "MA",
                ZipCode: "02124",
                PhoneNumber: "16175551500",
                PhoneExtension: null,
                Latitude: 42.2918,
                Longitude: -71.0677),
        };
    }

    [Inject]
    private IJSRuntime JSInterop { get; set; } = default!;
}
