@page "/weather"
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@using System.Security.Cryptography
@using Neba.Web.Server.Services
@inject INebaApi NebaApi
@inject INotificationService Notifications

<PageTitle>Weather</PageTitle>

<h1 class="text-3xl font-semibold mb-4 text-[var(--neba-text)]">Weather</h1>

<p class="mb-4 text-[var(--neba-text)]">This component demonstrates showing data and alert notifications via the unified NotificationService.</p>

@if (_isLoading)
{
    <div class="flex items-center gap-3">
        <div class="neba-spinner" aria-label="Loading"></div>
        <p class="text-[var(--neba-text)]"><em>Loading...</em></p>
    </div>
}
else if (_forecasts is not null)
{
    <table class="neba-table">
        <thead>
            <tr>
                <th class="text-left">Date</th>
                <th class="text-left" aria-label="Temperature in Celsius">Temp. (C)</th>
                <th class="text-left" aria-label="Temperature in Fahrenheit">Temp. (F)</th>
                <th class="text-left">Summary</th>
            </tr>
        </thead>
        <tbody>
            @foreach (WeatherForecast forecast in _forecasts)
            {
                <tr>
                    <td class="p-3">@forecast.Date.ToShortDateString()</td>
                    <td class="p-3">@forecast.TemperatureC</td>
                    <td class="p-3">@forecast.TemperatureF</td>
                    <td class="p-3">@forecast.Summary</td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private WeatherForecast[]? _forecasts;
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        _isLoading = true;

        try
        {
            // Simulate asynchronous loading to demonstrate streaming rendering
            await Task.Delay(500);
            _forecasts = await NebaApi.GetWeatherAsync();

            // Generate random number 1-10 for notification behavior testing
            int random = RandomNumberGenerator.GetInt32(1, 11);

            if (random == 1)
            {
                // AlertOnly - persistent notification
                Notifications.Normal($"{_forecasts.Length} weather records loaded", behavior: NotifyBehavior.AlertOnly);
                _forecasts = null; // Don't show grid
            }
            else if (random == 2)
            {
                var avgTemp = _forecasts.Average(f => f.TemperatureC);
                // AlertOnly - persistent notification
                Notifications.Info($"Weather data retrieved. Average temperature: {avgTemp:F1}°C", behavior: NotifyBehavior.AlertOnly);
                _forecasts = null;
            }
            else if (random == 3)
            {
                // ToastOnly - ephemeral success message
                Notifications.Success("All weather data validated successfully!", behavior: NotifyBehavior.ToastOnly);
                // Keep _forecasts to show grid
            }
            else if (random == 4)
            {
                // AlertOnly - persistent warning
                Notifications.Warning("Warning: Some weather records may contain estimated values", behavior: NotifyBehavior.AlertOnly);
                _forecasts = null;
            }
            else if (random == 5)
            {
                // AlertAndToast - critical error shown in both places
                Notifications.Error("API Error: Unable to verify weather data authenticity from external service",
                    behavior: NotifyBehavior.AlertAndToast);
                _forecasts = null;
            }
            // If random > 5, keep _forecasts and show grid normally without notification
        }
        catch (Exception ex)
        {
            // Critical errors should show both alert and toast
            Notifications.Error($"Failed to load weather data: {ex.Message}", behavior: NotifyBehavior.AlertAndToast);
            _forecasts = null;
        }
        finally
        {
            _isLoading = false;
        }
    }
}
