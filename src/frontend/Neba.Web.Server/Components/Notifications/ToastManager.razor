@using Neba.Web.Server.Services
@using System.Reactive.Linq
@implements IDisposable
@implements IAsyncDisposable
@inject INotificationService NotificationService
@inject IJSRuntime JS
@rendermode InteractiveServer

@if (_currentToast is not null)
{
    <div class="neba-toast-container">
        <NebaToast Payload="@_currentToast.Payload"
                  Duration="@_effectiveDuration"
                  PauseOnHover="@PauseOnHover"
                  OnDismiss="@HandleToastDismissed"
                  @key="_currentToast.Id" />
    </div>
}

@code {
    private readonly Queue<ToastItem> _toastQueue = new();
    private ToastItem? _currentToast;
    private IDisposable? _subscription;
    private IJSObjectReference? _module;
    private bool _isMobile;
    private TimeSpan _effectiveDuration = TimeSpan.FromSeconds(4);

    /// <summary>
    /// Whether to pause auto-dismiss timer when hovering over toasts.
    /// </summary>
    [Parameter]
    public bool PauseOnHover { get; set; } = true;

    protected override void OnInitialized()
    {
        _subscription = NotificationService.Notifications
            .Subscribe(payload =>
            {
                InvokeAsync(() =>
                {
                    AddToast(payload);
                    StateHasChanged();
                });
            });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./Components/Notifications/ToastManager.razor.js");
            _isMobile = await _module.InvokeAsync<bool>("isMobile");
            _effectiveDuration = _isMobile ? TimeSpan.FromSeconds(3) : TimeSpan.FromSeconds(4);
            StateHasChanged();
        }
    }

    private void AddToast(NotificationPayload payload)
    {
        var toastItem = new ToastItem
        {
            Id = Guid.NewGuid(),
            Payload = payload
        };

        // If no toast is currently displayed, show this one immediately
        if (_currentToast is null)
        {
            _currentToast = toastItem;
        }
        else
        {
            // Otherwise, queue it for later
            _toastQueue.Enqueue(toastItem);
        }
    }

    private void HandleToastDismissed()
    {
        // Clear current toast
        _currentToast = null;

        // Show next toast in queue if available
        if (_toastQueue.Count > 0)
        {
            _currentToast = _toastQueue.Dequeue();
        }

        StateHasChanged();
    }

    public void Dispose()
    {
        _subscription?.Dispose();
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }

        _subscription?.Dispose();
    }

    private sealed class ToastItem
    {
        public Guid Id { get; init; }
        public NotificationPayload Payload { get; init; } = null!;
    }
}
