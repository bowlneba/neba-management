@using Microsoft.JSInterop
@using Neba.Web.Server.Notifications
@implements IAsyncDisposable

<script src="./Components/NebaDocument.razor.js" type="module"></script>
<link rel="stylesheet" href="/neba-document.css" />

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="mb-6">
        <NebaAlert Severity="NotifySeverity.Error"
                   Title="@ErrorTitle"
                   Message="@ErrorMessage"
                   Dismissible="true"
                   OnDismiss="@HandleErrorDismiss" />
    </div>
}

<NebaLoadingIndicator IsVisible="@IsLoading"
                      Text="@LoadingText"
                      Scope="LoadingIndicatorScope.Page" />

@if (!IsLoading && Content.HasValue)
{
    <div class="neba-document-container" id="@ContainerId">
        @if (ShowTableOfContents)
        {
            <nav class="neba-document-toc" id="@TocId" aria-label="Table of Contents">
                <div class="toc-sticky">
                    <h2 class="toc-title">@TableOfContentsTitle</h2>
                    <div id="@TocListId"></div>
                </div>
            </nav>
        }

        <div class="neba-panel neba-document-content" id="@ContentId">
            @Content
        </div>
    </div>
}

@code {
    /// <summary>
    /// The HTML content to display in the document.
    /// </summary>
    [Parameter, EditorRequired]
    public MarkupString? Content { get; set; }

    /// <summary>
    /// Controls whether the loading indicator is visible.
    /// </summary>
    [Parameter]
    public bool IsLoading { get; set; }

    /// <summary>
    /// Text to display in the loading indicator.
    /// </summary>
    [Parameter]
    public string LoadingText { get; set; } = "Loading document...";

    /// <summary>
    /// Error message to display if document fails to load.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// Title for the error alert.
    /// </summary>
    [Parameter]
    public string ErrorTitle { get; set; } = "Error Loading Document";

    /// <summary>
    /// Callback invoked when the error alert is dismissed.
    /// </summary>
    [Parameter]
    public EventCallback OnErrorDismiss { get; set; }

    /// <summary>
    /// Controls whether to show the table of contents.
    /// </summary>
    [Parameter]
    public bool ShowTableOfContents { get; set; } = true;

    /// <summary>
    /// Title for the table of contents section.
    /// </summary>
    [Parameter]
    public string TableOfContentsTitle { get; set; } = "Contents";

    /// <summary>
    /// Heading levels to include in the table of contents (e.g., "h1, h2").
    /// </summary>
    [Parameter]
    public string HeadingLevels { get; set; } = "h1, h2";

    /// <summary>
    /// Unique identifier for this document instance. Auto-generated if not provided.
    /// </summary>
    [Parameter]
    public string? DocumentId { get; set; }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    private IJSObjectReference? _module;
    private bool _tocInitialized = false;
    private string _instanceId = Guid.NewGuid().ToString("N")[..8];

    private string ContainerId => $"neba-document-{_instanceId}";
    private string ContentId => $"neba-document-content-{_instanceId}";
    private string TocId => $"neba-document-toc-{_instanceId}";
    private string TocListId => $"neba-document-toc-list-{_instanceId}";

    protected override void OnInitialized()
    {
        if (!string.IsNullOrWhiteSpace(DocumentId))
        {
            _instanceId = DocumentId;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_tocInitialized || !Content.HasValue || !ShowTableOfContents)
            return;

        try
        {
            // Import the module
            _module ??= await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./Components/NebaDocument.razor.js");

            // Wait a bit for the DOM to be ready
            await Task.Delay(200);

            // Try to initialize TOC up to 5 times
            for (int i = 0; i < 5; i++)
            {
                var success = await _module.InvokeAsync<bool>("initializeToc", ContentId, TocListId, HeadingLevels);
                if (success)
                {
                    _tocInitialized = true;

                    // After successful initialization, scroll to hash if present
                    await _module.InvokeVoidAsync("scrollToHash", ContentId, TocListId);
                    break;
                }
                await Task.Delay(200);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing TOC: {ex.Message}");
        }
    }

    private async Task HandleErrorDismiss()
    {
        ErrorMessage = null;
        if (OnErrorDismiss.HasDelegate)
        {
            await OnErrorDismiss.InvokeAsync();
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }
    }
}
