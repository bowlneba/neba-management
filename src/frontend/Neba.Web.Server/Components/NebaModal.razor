@* Modal component with backdrop blur and centered content *@
@implements IAsyncDisposable
@inject IJSRuntime JsRuntime

@if (IsOpen)
{
    <div class="neba-modal-backdrop @CssClass"
         @onclick="HandleBackdropClick"
         style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; display: flex !important; align-items: center !important; justify-content: center !important; z-index: 1000 !important;">
        <div class="neba-modal-container" @onclick:stopPropagation="true">
            <div class="neba-modal-content @CssClass">
                @if (!string.IsNullOrWhiteSpace(Title))
                {
                    <div class="neba-modal-header">
                        <h2 class="neba-modal-title">@Title</h2>
                        @if (ShowCloseButton)
                        {
                            <button type="button"
                                    class="neba-modal-close"
                                    @onclick="HandleClose"
                                    aria-label="Close modal">
                                âœ•
                            </button>
                        }
                    </div>
                }

                <div class="neba-modal-body">
                    @ChildContent
                </div>

                @if (FooterContent != null)
                {
                    <div class="neba-modal-footer">
                        @FooterContent
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private IJSObjectReference? _module;

    /// <summary>
    /// Controls whether the modal is visible.
    /// </summary>
    [Parameter][EditorRequired]
    public bool IsOpen { get; set; }

    /// <summary>
    /// Callback invoked when the modal should be closed.
    /// </summary>
    [Parameter][EditorRequired]
    public EventCallback OnClose { get; set; }

    /// <summary>
    /// Optional title displayed at the top of the modal.
    /// </summary>
    [Parameter]
    public string? Title { get; set; }

    /// <summary>
    /// The main content to display in the modal body.
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Optional footer content (e.g., action buttons).
    /// </summary>
    [Parameter]
    public RenderFragment? FooterContent { get; set; }

    /// <summary>
    /// Whether to show the X close button in the header. Default is true.
    /// </summary>
    [Parameter]
    public bool ShowCloseButton { get; set; } = true;

    /// <summary>
    /// Whether clicking the backdrop should close the modal. Default is true.
    /// </summary>
    [Parameter]
    public bool CloseOnBackdropClick { get; set; } = true;

    /// <summary>
    /// Optional maximum width for the modal. Examples: "600px", "80%", "lg"
    /// </summary>
    [Parameter]
    public string? MaxWidth { get; set; }

    /// <summary>
    /// Optional CSS class to apply to the modal for custom styling.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    async protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JsRuntime.InvokeAsync<IJSObjectReference>("import", "./js/nebaModal.js");
        }

        if (_module != null)
        {
            await _module.InvokeVoidAsync("setBodyOverflow", IsOpen);
        }
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleBackdropClick()
    {
        if (CloseOnBackdropClick)
        {
            await HandleClose();
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }
    }
}
