@page "/tournaments/rules"
@using Neba.Web.Server.Notifications
@using Microsoft.JSInterop
@implements IAsyncDisposable
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject NebaApiService NebaApiService
@inject IJSRuntime JSInterop

<PageTitle>Tournament Rules - NEBA</PageTitle>

<script src="./Tournaments/TournamentRules.razor.js" type="module"></script>
<link rel="stylesheet" href="/tournament-rules.css" />

<!-- Page Header -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">NEBA Tournament Rules</h1>
    <p class="mt-1 text-sm text-gray-600">Official rules and regulations for NEBA tournaments</p>
</div>

<!-- Error Alert -->
@if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="mb-6">
        <NebaAlert Severity="NotifySeverity.Error"
                   Title="Error Loading Tournament Rules"
                   Message="@_errorMessage"
                   Dismissible="true"
                   OnDismiss="@(() => _errorMessage = null)" />
    </div>
}

<!-- Loading Indicator -->
<NebaLoadingIndicator IsVisible="@_isLoading"
                      Text="Loading tournament rules..."
                      Scope="LoadingIndicatorScope.Page" />

<!-- Rules Content with Table of Contents -->
@if (!_isLoading && _rulesHtml.HasValue)
{
    <div class="tournament-rules-container">
        <!-- Table of Contents (left side, hidden on mobile) -->
        <nav class="tournament-rules-toc" id="tournament-rules-toc" aria-label="Table of Contents">
            <div class="toc-sticky">
                <h2 class="toc-title">Contents</h2>
                <div id="toc-list"></div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="neba-panel tournament-rules-content" id="tournament-rules-content">
            @_rulesHtml
        </div>
    </div>
}

@code {
    private MarkupString? _rulesHtml;
    private string? _errorMessage;
    private bool _isLoading = true;
    private IJSObjectReference? _module;
    private bool _tocInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Add artificial 2000ms delay to simulate slower API
            await Task.Delay(2000);

            var result = await NebaApiService.GetTournamentRulesAsync();

            if (result.IsError)
            {
                var error = result.FirstError;
                _errorMessage = $"Failed to load tournament rules: {error.Description}";
                return;
            }

            _rulesHtml = result.Value;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load tournament rules: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_tocInitialized || !_rulesHtml.HasValue)
            return;

        try
        {
            // Import the module
            _module ??= await JSInterop.InvokeAsync<IJSObjectReference>("import", "./Tournaments/TournamentRules.razor.js");

            // Wait a bit for the DOM to be ready
            await Task.Delay(200);

            // Try to initialize TOC up to 5 times
            for (int i = 0; i < 5; i++)
            {
                var success = await _module.InvokeAsync<bool>("initializeToc");
                if (success)
                {
                    _tocInitialized = true;

                    // After successful initialization, scroll to hash if present
                    await _module.InvokeVoidAsync("scrollToHash");
                    break;
                }
                await Task.Delay(200);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing TOC: {ex.Message}");
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_module is not null)
        {
            await _module.DisposeAsync();
        }
    }
}
