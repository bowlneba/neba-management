@page "/history/champions"
@using Neba.Web.Server.Notifications
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject NebaApiService NebaApiService

<PageTitle>Champions - NEBA</PageTitle>

<div class="space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Champions</h1>
        <p class="mt-1 text-sm text-gray-600">NEBA tournament title leaders throughout history</p>
    </div>

    <!-- Error Alert -->
    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <NebaAlert Severity="NotifySeverity.Error"
                   Title="Error Loading Champions"
                   Message="@errorMessage"
                   Dismissible="true"
                   OnDismiss="@(() => errorMessage = null)" />
    }

    <!-- Loading Indicator -->
    <NebaLoadingIndicator IsVisible="@isLoading"
                          Text="Loading champions..."
                          Scope="LoadingIndicatorScope.Page" />

    <!-- View Toggle Segmented Control -->
    @if (!isLoading && champions.Count > 0)
    {
        <div class="flex justify-start">
            <NebaSegmentedControl Options="viewOptions"
                                  SelectedValue="@selectedView.ToString()"
                                  OnValueChanged="HandleViewChanged" />
        </div>
    }

    <!-- View Content -->
    @if (champions.Count > 0)
    {
        @if (selectedView == ChampionsView.TitleCount)
        {
            <TitleCountView Champions="champions" OnChampionClick="HandleChampionClick" />
        }
        else
        {
            <YearView TitlesByYear="@titlesByYear"
                      IsLoading="@isYearViewLoading"
                      ErrorMessage="@yearViewErrorMessage"
                      OnErrorDismiss="() => yearViewErrorMessage = null"
                      OnChampionClick="HandleYearViewChampionClick" />
        }
    }
</div>

<!-- Bowler Titles Modal -->
<BowlerTitlesModal IsOpen="@isModalOpen"
                   OnClose="@(() => isModalOpen = false)"
                   BowlerId="@selectedBowlerId"
                   BowlerName="@selectedBowlerName"
                   HallOfFame="@selectedBowlerHallOfFame" />

@code {
    private List<BowlerTitleSummaryViewModel> champions = new();
    private string? errorMessage;
    private bool isLoading = true;
    private ChampionsView selectedView = ChampionsView.TitleCount;

    // Year view data
    private List<TitlesByYearViewModel>? titlesByYear;
    private bool isYearViewLoading = false;
    private string? yearViewErrorMessage;

    // Modal state
    private bool isModalOpen = false;
    private Guid? selectedBowlerId;
    private string? selectedBowlerName;
    private bool selectedBowlerHallOfFame;

    // Segmented control options
    private readonly List<SegmentedControlOption> viewOptions = new()
    {
        new() { Label = "By Titles", Value = nameof(ChampionsView.TitleCount) },
        new() { Label = "By Year", Value = nameof(ChampionsView.Year) }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await NebaApiService.GetTitlesSummaryAsync();

            if (result.IsError)
            {
                var error = result.FirstError;
                errorMessage = $"Failed to load champions data: {error.Description}";
                return;
            }

            champions = result.Value.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load champions data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTitlesByYearAsync()
    {
        isYearViewLoading = true;
        yearViewErrorMessage = null;

        try
        {
            var result = await NebaApiService.GetTitlesByYearAsync();

            if (result.IsError)
            {
                var error = result.FirstError;
                yearViewErrorMessage = $"Failed to load titles: {error.Description}";
                return;
            }

            titlesByYear = result.Value.ToList();
        }
        catch (Exception ex)
        {
            yearViewErrorMessage = $"Failed to load titles: {ex.Message}";
        }
        finally
        {
            isYearViewLoading = false;
        }
    }

    private async Task HandleViewChanged(string viewValue)
    {
        var newView = Enum.Parse<ChampionsView>(viewValue);
        if (newView == ChampionsView.Year && titlesByYear == null)
        {
            await LoadTitlesByYearAsync();
        }
        selectedView = newView;
    }

    private void HandleChampionClick(BowlerTitleSummaryViewModel champion)
    {
        selectedBowlerId = champion.BowlerId;
        selectedBowlerName = champion.BowlerName;
        selectedBowlerHallOfFame = champion.HallOfFame;
        isModalOpen = true;
    }

    private void HandleYearViewChampionClick(BowlerTitleViewModel title)
    {
        selectedBowlerId = title.BowlerId;
        selectedBowlerName = title.BowlerName;
        selectedBowlerHallOfFame = title.HallOfFame;
        isModalOpen = true;
    }
}
