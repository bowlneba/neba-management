@page "/history/champions"
@rendermode @(new InteractiveServerRenderMode(prerender: false))

@inject NebaApiService NebaApiService

<PageTitle>Champions - NEBA</PageTitle>

<div class="space-y-6">
    <!-- Page Header -->
    <div>
        <h1 class="text-3xl font-bold text-gray-900">Champions</h1>
        <p class="mt-1 text-sm text-gray-600">NEBA tournament title leaders throughout history</p>
    </div>

    <!-- Error Alert -->
    @if (!string.IsNullOrWhiteSpace(errorMessage))
    {
        <NebaAlert Severity="NotifySeverity.Error"
                   Title="Error Loading Champions"
                   Message="@errorMessage"
                   Dismissible="true"
                   OnDismiss="@(() => errorMessage = null)" />
    }

    <!-- Loading Indicator -->
    <NebaLoadingIndicator IsVisible="@isLoading"
                          Text="Loading champions..."
                          Scope="LoadingIndicatorScope.Page" />

    <!-- Cards Layout -->
    @if (champions.Count > 0)
    {
        <CardGridLayout Champions="champions" OnChampionClick="HandleChampionClick" />
    }
</div>

<!-- Bowler Titles Modal -->
<BowlerTitlesModal IsOpen="@isModalOpen"
                   OnClose="@(() => isModalOpen = false)"
                   BowlerId="@selectedBowlerId"
                   BowlerName="@selectedBowlerName"
                   HallOfFame="@selectedBowlerHallOfFame" />

@code {
    private List<BowlerTitleCountViewModel> champions = new();
    private string? errorMessage;
    private bool isLoading = true;

    // Modal state
    private bool isModalOpen = false;
    private Guid? selectedBowlerId;
    private string? selectedBowlerName;
    private bool selectedBowlerHallOfFame;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await NebaApiService.GetBowlerTitleCountsAsync();

            if (result.IsError)
            {
                var error = result.FirstError;
                errorMessage = $"Failed to load champions data: {error.Description}";
                return;
            }

            champions = result.Value.Items.Select(getBowlerTitleCountsResponse => getBowlerTitleCountsResponse.ToViewModel()).ToList();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleChampionClick(BowlerTitleCountViewModel champion)
    {
        selectedBowlerId = champion.BowlerId;
        selectedBowlerName = champion.BowlerName;
        selectedBowlerHallOfFame = champion.HallOfFame;
        isModalOpen = true;
    }
}
