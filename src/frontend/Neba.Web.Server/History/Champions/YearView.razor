@using Neba.Web.Server.Notifications
@inject NebaApiService NebaApiService

@if (isLoading)
{
    <div class="flex justify-center items-center py-12">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[var(--neba-blue-700)]"></div>
            <p class="mt-4 text-gray-600">Loading titles by year...</p>
        </div>
    </div>
}
else if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="py-6">
        <NebaAlert Severity="NotifySeverity.Error"
                   Title="Error Loading Titles"
                   Message="@errorMessage"
                   Dismissible="true"
                   OnDismiss="@(() => errorMessage = null)" />
    </div>
}
else if (titlesByYear.Count == 0)
{
    <div class="text-center py-12 text-gray-500">
        No titles found.
    </div>
}
else
{
    <div class="space-y-4">
        @foreach (var yearGroup in titlesByYear.OrderByDescending(g => g.Year))
        {
            var sectionId = $"year-{yearGroup.Year}";
            var isExpanded = expandedSections.Contains(sectionId);

            <div>
                <button type="button"
                        class="year-header w-full flex items-center justify-between"
                        @onclick="() => ToggleSection(sectionId)">
                    <h3 class="text-xl font-semibold text-blue-900">
                        @yearGroup.Year
                        <span class="text-sm text-blue-700 italic ml-2">@yearGroup.Titles.Count @(yearGroup.Titles.Count == 1 ? "title" : "titles")</span>
                    </h3>
                    <span class="text-blue-900 text-lg transition-transform @(isExpanded ? "rotate-90" : "")">
                        â–¶
                    </span>
                </button>

                <div class="year-collapse-container @(isExpanded ? "year-expanded" : "year-collapsed")">
                    <div class="mt-3">
                        <div class="overflow-hidden rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">
                                            Month
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">
                                            Tournament Type
                                        </th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            Champions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    @foreach (var monthGroup in yearGroup.Titles.GroupBy(t => t.TournamentMonth).OrderByDescending(g => g.Key))
                                    {
                                        @foreach (var typeGroup in monthGroup.GroupBy(t => t.TournamentType).OrderBy(g => g.Key))
                                        {
                                            var champions = typeGroup.ToList();
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-4 py-3 text-sm text-gray-700 font-medium">@GetMonthName(monthGroup.Key)</td>
                                                <td class="px-4 py-3">
                                                    <span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 whitespace-nowrap">
                                                        @typeGroup.Key
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-sm">
                                                    @for (int i = 0; i < champions.Count; i++)
                                                    {
                                                        var champion = champions[i];
                                                        <button type="button"
                                                                class="champion-name font-medium"
                                                                @onclick="() => HandleChampionClick(champion)">
                                                            @champion.BowlerName</button>@if (i < champions.Count - 1)
                                                        {
                                                            <text>, </text>
                                                        }
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public EventCallback<BowlerTitleViewModel> OnChampionClick { get; set; }

    private List<TitlesByYearViewModel> titlesByYear = new();
    private string? errorMessage;
    private bool isLoading = true;
    private readonly HashSet<string> expandedSections = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadTitlesAsync();
    }

    private async Task LoadTitlesAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var result = await NebaApiService.GetTitlesByYearAsync();

            if (result.IsError)
            {
                var error = result.FirstError;
                errorMessage = $"Failed to load titles: {error.Description}";
                return;
            }

            titlesByYear = result.Value.ToList();

            // Expand all sections by default
            foreach (var yearGroup in titlesByYear)
            {
                expandedSections.Add($"year-{yearGroup.Year}");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load titles: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ToggleSection(string sectionId)
    {
        if (expandedSections.Contains(sectionId))
        {
            expandedSections.Remove(sectionId);
        }
        else
        {
            expandedSections.Add(sectionId);
        }
    }

    private async Task HandleChampionClick(BowlerTitleViewModel title)
    {
        await OnChampionClick.InvokeAsync(title);
    }

    private static string GetMonthName(int month)
    {
        return month switch
        {
            1 => "January",
            2 => "February",
            3 => "March",
            4 => "April",
            5 => "May",
            6 => "June",
            7 => "July",
            8 => "August",
            9 => "September",
            10 => "October",
            11 => "November",
            12 => "December",
            _ => "Unknown"
        };
    }
}
