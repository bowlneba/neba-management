name: Deploy Infrastructure

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'infrastructure/**'
  #     - '.github/workflows/deploy_infrastructure.yml'

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep syntax
        run: |
          az bicep build --file infrastructure/main.bicep
          echo "âœ… Bicep syntax validation passed"

      - name: Run What-If analysis
        run: |
          az deployment sub what-if \
            --location ${{ vars.AZURE_LOCATION }} \
            --template-file infrastructure/main.bicep \
            --parameters \
              azureResourceGroupName='${{ vars.AZURE_RESOURCE_GROUP_NAME }}' \
              azureLocation='${{ vars.AZURE_LOCATION }}' \
              azureEnvironment='${{ vars.AZURE_ENVIRONMENT }}' \
              azureAppServicePlanName='${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}' \
              azureApiAppServiceName='${{ vars.AZURE_API_APP_SERVICE_NAME }}' \
              azureWebAppServiceName='${{ vars.AZURE_WEB_APP_SERVICE_NAME }}' \
              azureAppServicePlanSku='${{ vars.AZURE_APP_SERVICE_PLAN_SKU }}' \
              databaseServerName='${{ vars.DATABASE_SERVER_NAME }}' \
              databaseName='${{ vars.DATABASE_NAME }}' \
              databaseAdminUsername='${{ vars.DATABASE_ADMIN_USERNAME }}' \
              databaseAdminPassword='${{ secrets.DATABASE_ADMIN_PASSWORD }}' \
              azurePostgresSku='${{ vars.AZURE_POSTGRES_SKU }}' \
              azurePostgresStorageSizeGB=${{ vars.AZURE_POSTGRES_STORAGE_SIZE_GB }} \
              postgresVersion='${{ vars.POSTGRES_VERSION }}' \
              azurePostgresBackupRetentionDays=${{ vars.AZURE_POSTGRES_BACKUP_RETENTION_DAYS }}

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    environment: Production
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure
        id: deploy
        run: |
          echo "ðŸš€ Deploying infrastructure to ${{ vars.AZURE_ENVIRONMENT }} environment in ${{ vars.AZURE_LOCATION }}"

          az deployment sub create \
            --name "infrastructure-${{ vars.AZURE_ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)" \
            --location ${{ vars.AZURE_LOCATION }} \
            --template-file infrastructure/main.bicep \
            --parameters \
              azureResourceGroupName='${{ vars.AZURE_RESOURCE_GROUP_NAME }}' \
              azureLocation='${{ vars.AZURE_LOCATION }}' \
              azureEnvironment='${{ vars.AZURE_ENVIRONMENT }}' \
              azureAppServicePlanName='${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}' \
              azureApiAppServiceName='${{ vars.AZURE_API_APP_SERVICE_NAME }}' \
              azureWebAppServiceName='${{ vars.AZURE_WEB_APP_SERVICE_NAME }}' \
              azureAppServicePlanSku='${{ vars.AZURE_APP_SERVICE_PLAN_SKU }}' \
              databaseServerName='${{ vars.DATABASE_SERVER_NAME }}' \
              databaseName='${{ vars.DATABASE_NAME }}' \
              databaseAdminUsername='${{ vars.DATABASE_ADMIN_USERNAME }}' \
              databaseAdminPassword='${{ secrets.DATABASE_ADMIN_PASSWORD }}' \
              azurePostgresSku='${{ vars.AZURE_POSTGRES_SKU }}' \
              azurePostgresStorageSizeGB=${{ vars.AZURE_POSTGRES_STORAGE_SIZE_GB }} \
              postgresVersion='${{ vars.POSTGRES_VERSION }}' \
              azurePostgresBackupRetentionDays=${{ vars.AZURE_POSTGRES_BACKUP_RETENTION_DAYS }} \
            --output json > deployment-output.json

          echo "âœ… Infrastructure deployment completed"

      - name: Extract Deployment Outputs
        id: outputs
        run: |
          API_URL=$(cat deployment-output.json | jq -r '.properties.outputs.apiAppServiceUrl.value')
          WEB_URL=$(cat deployment-output.json | jq -r '.properties.outputs.webAppServiceUrl.value')
          DB_SERVER=$(cat deployment-output.json | jq -r '.properties.outputs.postgreSqlServerFqdn.value')
          DB_NAME=$(cat deployment-output.json | jq -r '.properties.outputs.postgreSqlDatabaseName.value')
          API_PRINCIPAL_ID=$(cat deployment-output.json | jq -r '.properties.outputs.apiAppServicePrincipalId.value')

          echo "api-url=$API_URL" >> $GITHUB_OUTPUT
          echo "web-url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "db-server=$DB_SERVER" >> $GITHUB_OUTPUT
          echo "db-name=$DB_NAME" >> $GITHUB_OUTPUT
          echo "api-principal-id=$API_PRINCIPAL_ID" >> $GITHUB_OUTPUT

          echo "### ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ vars.AZURE_ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ vars.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Web URL:** $WEB_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Database Server:** $DB_SERVER" >> $GITHUB_STEP_SUMMARY
          echo "**Database Name:** $DB_NAME" >> $GITHUB_STEP_SUMMARY

      - name: Configure Database Access for API Managed Identity
        run: |
          echo "ðŸ” Configuring Managed Identity access to PostgreSQL..."

          # Get the API App Service Managed Identity principal ID
          API_PRINCIPAL_ID="${{ steps.outputs.outputs.api-principal-id }}"
          API_APP_NAME="${{ vars.AZURE_API_APP_SERVICE_NAME }}-${{ vars.AZURE_LOCATION }}"

          # Add API's Managed Identity as Azure AD admin for PostgreSQL
          az postgres flexible-server ad-admin create \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP_NAME }} \
            --server-name ${{ vars.DATABASE_SERVER_NAME }}-${{ vars.AZURE_LOCATION }} \
            --display-name "$API_APP_NAME" \
            --object-id "$API_PRINCIPAL_ID" \
            --type ServicePrincipal || echo "AD admin already exists or failed to create"

          echo "âœ… Managed Identity configured for database access"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Database Access:** API Managed Identity configured" >> $GITHUB_STEP_SUMMARY

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v5
        with:
          name: deployment-output-${{ vars.AZURE_ENVIRONMENT }}
          path: deployment-output.json
          retention-days: 30
