name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'Production'
        type: string
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'Production'
        type: string
    secrets:
      DATABASE_ADMIN_PASSWORD:
        description: 'PostgreSQL database admin password'
        required: true
      DATABASE_WEB_PASSWORD:
        description: 'PostgreSQL website user password'
        required: true
      DATABASE_JOBS_PASSWORD:
        description: 'PostgreSQL Hangfire jobs user password'
        required: true
      DATABASE_CACHE_PASSWORD:
        description: 'PostgreSQL cache user password'
        required: true
      GOOGLE_DOCS_CLIENT_EMAIL:
        description: 'Google Docs service account client email'
        required: false
      GOOGLE_DOCS_CLIENT_ID:
        description: 'Google Docs service account client ID'
        required: false
      GOOGLE_DOCS_CLIENT_X509_CERT_URL:
        description: 'Google Docs service account certificate URL'
        required: false
      GOOGLE_DOCS_PRIVATE_KEY:
        description: 'Google Docs service account private key'
        required: false
      GOOGLE_DOCS_PRIVATE_KEY_ID:
        description: 'Google Docs service account private key ID'
        required: false

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'Production' }}
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep syntax
        run: |
          az bicep build --file infrastructure/main.bicep
          echo "âœ… Bicep syntax validation passed"

      - name: Run What-If analysis
        env:
          DATABASE_ADMIN_PASSWORD: ${{ secrets.DATABASE_ADMIN_PASSWORD }}
        run: |
          az deployment sub what-if \
            --location ${{ vars.AZURE_LOCATION }} \
            --template-file infrastructure/main.bicep \
            --parameters \
              azureResourceGroupName='${{ vars.AZURE_RESOURCE_GROUP_NAME }}' \
              azureLocation='${{ vars.AZURE_LOCATION }}' \
              azureEnvironment='${{ vars.AZURE_ENVIRONMENT }}' \
              azureAppServicePlanName='${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}' \
              azureApiAppServiceName='${{ vars.AZURE_API_APP_SERVICE_NAME }}' \
              azureWebAppServiceName='${{ vars.AZURE_WEB_APP_SERVICE_NAME }}' \
              azureAppServicePlanSku='${{ vars.AZURE_APP_SERVICE_PLAN_SKU }}' \
              databaseServerName='${{ vars.DATABASE_SERVER_NAME }}' \
              databaseName='${{ vars.DATABASE_NAME }}' \
              databaseAdminUsername='${{ vars.DATABASE_ADMIN_USERNAME }}' \
              databaseAdminPassword="$DATABASE_ADMIN_PASSWORD" \
              azurePostgresSku='${{ vars.AZURE_POSTGRES_SKU }}' \
              azurePostgresStorageSizeGB=${{ vars.AZURE_POSTGRES_STORAGE_SIZE_GB }} \
              postgresVersion='${{ vars.POSTGRES_VERSION }}' \
              azurePostgresBackupRetentionDays=${{ vars.AZURE_POSTGRES_BACKUP_RETENTION_DAYS }} \
              azureKeyVaultName='${{ vars.AZURE_KEY_VAULT_NAME }}' \
              azureStorageAccountName='${{ vars.AZURE_STORAGE_ACCOUNT_NAME }}'

  deploy:
    name: Deploy to ${{ inputs.environment || 'Production' }}
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ inputs.environment || 'Production' }}
    permissions:
      id-token: write  # Required for OIDC authentication
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure
        id: deploy
        env:
          DATABASE_ADMIN_PASSWORD: ${{ secrets.DATABASE_ADMIN_PASSWORD }}
        run: |
          echo "ðŸš€ Deploying infrastructure to ${{ vars.AZURE_ENVIRONMENT }} environment in ${{ vars.AZURE_LOCATION }}"
          echo "ðŸ“¦ Resources to be deployed:"
          echo "  - Resource Group: ${{ vars.AZURE_RESOURCE_GROUP_NAME }}"
          echo "  - App Service Plan: ${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}"
          echo "  - API App Service: ${{ vars.AZURE_API_APP_SERVICE_NAME }}"
          echo "  - Web App Service: ${{ vars.AZURE_WEB_APP_SERVICE_NAME }}"
          echo "  - PostgreSQL Server: ${{ vars.DATABASE_SERVER_NAME }}-${{ vars.AZURE_LOCATION }}"
          echo "  - Key Vault: ${{ vars.AZURE_KEY_VAULT_NAME }}-${{ vars.AZURE_LOCATION }}"
          echo "  - Storage Account: ${{ vars.AZURE_STORAGE_ACCOUNT_NAME }}${{ vars.AZURE_LOCATION }}"
          echo ""
          echo "â±ï¸  Expected deployment time: 15-25 minutes (PostgreSQL takes 8-15 minutes)"
          echo ""

          DEPLOYMENT_NAME="infrastructure-${{ vars.AZURE_ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)"

          # Start deployment in background
          az deployment sub create \
            --name "$DEPLOYMENT_NAME" \
            --location ${{ vars.AZURE_LOCATION }} \
            --template-file infrastructure/main.bicep \
            --parameters \
              azureResourceGroupName='${{ vars.AZURE_RESOURCE_GROUP_NAME }}' \
              azureLocation='${{ vars.AZURE_LOCATION }}' \
              azureEnvironment='${{ vars.AZURE_ENVIRONMENT }}' \
              azureAppServicePlanName='${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}' \
              azureApiAppServiceName='${{ vars.AZURE_API_APP_SERVICE_NAME }}' \
              azureWebAppServiceName='${{ vars.AZURE_WEB_APP_SERVICE_NAME }}' \
              azureAppServicePlanSku='${{ vars.AZURE_APP_SERVICE_PLAN_SKU }}' \
              databaseServerName='${{ vars.DATABASE_SERVER_NAME }}' \
              databaseName='${{ vars.DATABASE_NAME }}' \
              databaseAdminUsername='${{ vars.DATABASE_ADMIN_USERNAME }}' \
              databaseAdminPassword="$DATABASE_ADMIN_PASSWORD" \
              azurePostgresSku='${{ vars.AZURE_POSTGRES_SKU }}' \
              azurePostgresStorageSizeGB=${{ vars.AZURE_POSTGRES_STORAGE_SIZE_GB }} \
              postgresVersion='${{ vars.POSTGRES_VERSION }}' \
              azurePostgresBackupRetentionDays=${{ vars.AZURE_POSTGRES_BACKUP_RETENTION_DAYS }} \
              azureKeyVaultName='${{ vars.AZURE_KEY_VAULT_NAME }}' \
              azureStorageAccountName='${{ vars.AZURE_STORAGE_ACCOUNT_NAME }}' \
            --no-wait

          echo ""
          echo "ðŸ“Š Monitoring deployment progress..."
          echo ""

          # Monitor deployment with progress updates
          while true; do
            STATE=$(az deployment sub show --name "$DEPLOYMENT_NAME" --query 'properties.provisioningState' -o tsv 2>/dev/null || echo "NotFound")

            if [ "$STATE" = "Succeeded" ]; then
              echo "âœ… Deployment completed successfully!"
              break
            elif [ "$STATE" = "Failed" ]; then
              echo "âŒ Deployment failed"
              az deployment sub show --name "$DEPLOYMENT_NAME" --query 'properties.error' -o json
              exit 1
            elif [ "$STATE" = "Canceled" ]; then
              echo "âš ï¸  Deployment was canceled"
              exit 1
            fi

            # Show active operations
            OPERATIONS=$(az deployment sub show --name "$DEPLOYMENT_NAME" --query "properties.dependencies[].{resource:resourceType, state:dependsOn[0].resourceName}" -o tsv 2>/dev/null || echo "")
            TIMESTAMP=$(date '+%H:%M:%S')
            echo "[$TIMESTAMP] Deployment status: $STATE"

            # Check resource group deployment status
            if az group show --name '${{ vars.AZURE_RESOURCE_GROUP_NAME }}' &>/dev/null; then
              echo "  âœ“ Resource Group created"

              # Check individual resources
              RESOURCES=$(az resource list --resource-group '${{ vars.AZURE_RESOURCE_GROUP_NAME }}' --query '[].{Type:type, Name:name, State:provisioningState}' -o tsv 2>/dev/null)
              if [ -n "$RESOURCES" ]; then
                echo "$RESOURCES" | while IFS=$'\t' read -r type name state; do
                  case "$type" in
                    *"Microsoft.Web/serverfarms"*) echo "  â³ App Service Plan: $state" ;;
                    *"Microsoft.Web/sites"*) echo "  â³ App Service ($name): $state" ;;
                    *"Microsoft.DBforPostgreSQL/flexibleServers"*) echo "  â³ PostgreSQL Server: $state (this takes 8-15 min)" ;;
                    *"Microsoft.KeyVault/vaults"*) echo "  â³ Key Vault: $state" ;;
                    *"Microsoft.Storage/storageAccounts"*) echo "  â³ Storage Account: $state" ;;
                  esac
                done
              fi
            else
              echo "  â³ Creating resource group..."
            fi

            echo ""
            sleep 30
          done

          # Get final output
          az deployment sub show --name "$DEPLOYMENT_NAME" --query 'properties.outputs' -o json > deployment-output.json

          echo "âœ… Infrastructure deployment completed"

      - name: Extract Deployment Outputs
        id: outputs
        run: |
          API_URL=$(cat deployment-output.json | jq -r '.properties.outputs.apiAppServiceUrl.value')
          WEB_URL=$(cat deployment-output.json | jq -r '.properties.outputs.webAppServiceUrl.value')
          DB_SERVER=$(cat deployment-output.json | jq -r '.properties.outputs.postgreSqlServerFqdn.value')
          DB_NAME=$(cat deployment-output.json | jq -r '.properties.outputs.postgreSqlDatabaseName.value')
          KV_NAME=$(cat deployment-output.json | jq -r '.properties.outputs.keyVaultName.value')
          KV_URI=$(cat deployment-output.json | jq -r '.properties.outputs.keyVaultUri.value')
          STORAGE_NAME=$(cat deployment-output.json | jq -r '.properties.outputs.storageAccountName.value')
          STORAGE_BLOB_ENDPOINT=$(cat deployment-output.json | jq -r '.properties.outputs.storageAccountBlobEndpoint.value')

          echo "api-url=$API_URL" >> $GITHUB_OUTPUT
          echo "web-url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "db-server=$DB_SERVER" >> $GITHUB_OUTPUT
          echo "db-name=$DB_NAME" >> $GITHUB_OUTPUT
          echo "kv-name=$KV_NAME" >> $GITHUB_OUTPUT
          echo "kv-uri=$KV_URI" >> $GITHUB_OUTPUT
          echo "storage-name=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "storage-blob-endpoint=$STORAGE_BLOB_ENDPOINT" >> $GITHUB_OUTPUT

          echo "### ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ vars.AZURE_ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ vars.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Web URL:** $WEB_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Database Server:** $DB_SERVER" >> $GITHUB_STEP_SUMMARY
          echo "**Database Name:** $DB_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Key Vault:** $KV_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Storage Account:** $STORAGE_NAME" >> $GITHUB_STEP_SUMMARY

      - name: Add Secrets to Key Vault
        env:
          DATABASE_ADMIN_PASSWORD: ${{ secrets.DATABASE_ADMIN_PASSWORD }}
          DATABASE_WEB_PASSWORD: ${{ secrets.DATABASE_WEB_PASSWORD }}
          DATABASE_JOBS_PASSWORD: ${{ secrets.DATABASE_JOBS_PASSWORD }}
          GOOGLE_DOCS_CLIENT_EMAIL: ${{ secrets.GOOGLE_DOCS_CLIENT_EMAIL }}
          GOOGLE_DOCS_CLIENT_ID: ${{ secrets.GOOGLE_DOCS_CLIENT_ID }}
          GOOGLE_DOCS_CLIENT_X509_CERT_URL: ${{ secrets.GOOGLE_DOCS_CLIENT_X509_CERT_URL }}
          GOOGLE_DOCS_PRIVATE_KEY: ${{ secrets.GOOGLE_DOCS_PRIVATE_KEY }}
          GOOGLE_DOCS_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_DOCS_PRIVATE_KEY_ID }}
        run: |
          echo "ðŸ” Adding secrets to Key Vault..."

          # Get values directly from Azure resources since deployment may have had issues
          KV_NAME=$(az keyvault list --resource-group ${{ vars.AZURE_RESOURCE_GROUP_NAME }} --query '[0].name' -o tsv)
          DB_SERVER=$(az postgres flexible-server show --resource-group ${{ vars.AZURE_RESOURCE_GROUP_NAME }} --name ${{ vars.DATABASE_SERVER_NAME }}-${{ vars.AZURE_LOCATION }} --query 'fullyQualifiedDomainName' -o tsv)
          DB_NAME="${{ vars.DATABASE_NAME }}"
          WEB_USERNAME="${{ vars.DATABASE_WEB_USERNAME }}"
          JOBS_USERNAME="${{ vars.DATABASE_JOBS_USERNAME }}"

          echo "Key Vault: $KV_NAME"
          echo "Database Server: $DB_SERVER"
          echo "Database Name: $DB_NAME"
          echo "Website Username: $WEB_USERNAME"
          echo "Jobs Username: $JOBS_USERNAME"

          # Get the currently authenticated service principal's object ID
          # For OIDC, az account show returns the client/app ID, we need to get the object ID
          SP_CLIENT_ID=$(az account show --query user.name -o tsv)
          SP_OBJECT_ID=$(az ad sp show --id "$SP_CLIENT_ID" --query id -o tsv)

          echo "Service Principal Client ID: $SP_CLIENT_ID"
          echo "Service Principal Object ID: $SP_OBJECT_ID"

          # Get Key Vault resource ID
          KV_ID=$(az keyvault show --name "$KV_NAME" --resource-group ${{ vars.AZURE_RESOURCE_GROUP_NAME }} --query id -o tsv)

          # Grant temporary Key Vault Secrets Officer access to current service principal
          echo "Granting Key Vault Secrets Officer role..."
          az role assignment create \
            --role "Key Vault Secrets Officer" \
            --assignee-object-id "$SP_OBJECT_ID" \
            --assignee-principal-type ServicePrincipal \
            --scope "$KV_ID" \
            --output none 2>&1 || echo "âš ï¸  Role assignment may already exist"

          # Wait for RBAC to propagate (can take up to 5 minutes)
          echo "Waiting for RBAC permissions to propagate..."
          sleep 30

          # Create connection string for migrations (using admin credentials)
          MIGRATION_CONNECTION_STRING="Host=$DB_SERVER;Database=$DB_NAME;Username=${{ vars.DATABASE_ADMIN_USERNAME }};Password=$DATABASE_ADMIN_PASSWORD;SslMode=Require"

          # Add migration connection string to Key Vault
          echo "Adding ConnectionStrings--website-migrations..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "ConnectionStrings--website-migrations" \
            --value "$MIGRATION_CONNECTION_STRING" \
            --output none

          # Create connection string for website (using website user credentials)
          WEBSITE_CONNECTION_STRING="Host=$DB_SERVER;Database=$DB_NAME;Username=$WEB_USERNAME;Password=$DATABASE_WEB_PASSWORD;SslMode=Require;SearchPath=website"

          # Add website connection string to Key Vault
          echo "Adding ConnectionStrings--website..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "ConnectionStrings--website" \
            --value "$WEBSITE_CONNECTION_STRING" \
            --output none

          # Create connection string for Hangfire background jobs
          HANGFIRE_CONNECTION_STRING="Host=$DB_SERVER;Database=$DB_NAME;Username=$JOBS_USERNAME;Password=$DATABASE_JOBS_PASSWORD;SslMode=Require;SearchPath=hangfire"

          # Add Hangfire connection string to Key Vault
          echo "Adding ConnectionStrings--hangfire..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "ConnectionStrings--hangfire" \
            --value "$HANGFIRE_CONNECTION_STRING" \
            --output none

          # Add database admin password to Key Vault for manual access
          echo "Adding DatabaseAdminPassword..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "DatabaseAdminPassword" \
            --value "$DATABASE_ADMIN_PASSWORD" \
            --output none

          # Add Google Docs credentials to Key Vault
          echo "Adding GoogleDocs--Credentials--ClientEmail..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--ClientEmail" \
            --value "$GOOGLE_DOCS_CLIENT_EMAIL" \
            --output none

          echo "Adding GoogleDocs--Credentials--ClientId..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--ClientId" \
            --value "$GOOGLE_DOCS_CLIENT_ID" \
            --output none

          echo "Adding GoogleDocs--Credentials--ClientX509CertUrl..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--ClientX509CertUrl" \
            --value "$GOOGLE_DOCS_CLIENT_X509_CERT_URL" \
            --output none

          echo "Adding GoogleDocs--Credentials--PrivateKey..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--PrivateKey" \
            --value "$GOOGLE_DOCS_PRIVATE_KEY" \
            --output none

          echo "Adding GoogleDocs--Credentials--PrivateKeyId..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--PrivateKeyId" \
            --value "$GOOGLE_DOCS_PRIVATE_KEY_ID" \
            --output none

          echo "âœ… Secrets added to Key Vault"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Vault Secrets:** ConnectionStrings--website-migrations, ConnectionStrings--website, ConnectionStrings--hangfire, DatabaseAdminPassword, GoogleDocs credentials" >> $GITHUB_STEP_SUMMARY

      - name: Setup Database Schema Users
        env:
          DATABASE_ADMIN_PASSWORD: ${{ secrets.DATABASE_ADMIN_PASSWORD }}
          DATABASE_WEB_PASSWORD: ${{ secrets.DATABASE_WEB_PASSWORD }}
          DATABASE_JOBS_PASSWORD: ${{ secrets.DATABASE_JOBS_PASSWORD }}
        run: |
          echo "ðŸ‘¤ Setting up database schema-specific users..."

          DB_SERVER=$(az postgres flexible-server show --resource-group ${{ vars.AZURE_RESOURCE_GROUP_NAME }} --name ${{ vars.DATABASE_SERVER_NAME }}-${{ vars.AZURE_LOCATION }} --query 'fullyQualifiedDomainName' -o tsv)
          DB_NAME="${{ vars.DATABASE_NAME }}"
          ADMIN_USERNAME="${{ vars.DATABASE_ADMIN_USERNAME }}"
          WEB_USERNAME="${{ vars.DATABASE_WEB_USERNAME }}"
          JOBS_USERNAME="${{ vars.DATABASE_JOBS_USERNAME }}"

          echo "Setting up website user with access to 'website' schema..."

          # Run the schema user setup script for website
          PGPASSWORD="$DATABASE_ADMIN_PASSWORD" psql \
            "host=$DB_SERVER port=5432 dbname=$DB_NAME user=$ADMIN_USERNAME sslmode=require" \
            -v schema_name='website' \
            -v username="$WEB_USERNAME" \
            -v password="$DATABASE_WEB_PASSWORD" \
            -f infrastructure/database/setup-schema-user.sql

          if [ $? -eq 0 ]; then
            echo "âœ… Website user created successfully with permissions on 'website' schema"
          else
            echo "âŒ Failed to create website user with permissions on 'website' schema" >&2
            exit 1
          fi

          echo "Setting up jobs user with access to 'hangfire' schema..."

          # Run the schema user setup script for Hangfire jobs
          PGPASSWORD="$DATABASE_ADMIN_PASSWORD" psql \
            "host=$DB_SERVER port=5432 dbname=$DB_NAME user=$ADMIN_USERNAME sslmode=require" \
            -v schema_name='hangfire' \
            -v username="$JOBS_USERNAME" \
            -v password="$DATABASE_JOBS_PASSWORD" \
            -f infrastructure/database/setup-schema-user.sql

          if [ $? -eq 0 ]; then
            echo "âœ… Jobs user created successfully with permissions on 'hangfire' schema"
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Database Users:** Website user and Jobs user configured with CRUD access to their respective schemas" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Failed to create jobs user with permissions on 'hangfire' schema" >&2
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Database Users:** Failed to configure jobs user. See logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v5
        with:
          name: deployment-output-${{ vars.AZURE_ENVIRONMENT }}
          path: deployment-output.json
          retention-days: 30
