name: Deploy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'Production'
        type: string
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'Production'
        type: string
    secrets:
      DATABASE_ADMIN_PASSWORD:
        description: 'PostgreSQL database admin password'
        required: true

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'Production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep syntax
        run: |
          az bicep build --file infrastructure/main.bicep
          echo "âœ… Bicep syntax validation passed"

      - name: Run What-If analysis
        env:
          DATABASE_ADMIN_PASSWORD: ${{ secrets.DATABASE_ADMIN_PASSWORD }}
        run: |
          az deployment sub what-if \
            --location ${{ vars.AZURE_LOCATION }} \
            --template-file infrastructure/main.bicep \
            --parameters \
              azureResourceGroupName='${{ vars.AZURE_RESOURCE_GROUP_NAME }}' \
              azureLocation='${{ vars.AZURE_LOCATION }}' \
              azureEnvironment='${{ vars.AZURE_ENVIRONMENT }}' \
              azureAppServicePlanName='${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}' \
              azureApiAppServiceName='${{ vars.AZURE_API_APP_SERVICE_NAME }}' \
              azureWebAppServiceName='${{ vars.AZURE_WEB_APP_SERVICE_NAME }}' \
              azureAppServicePlanSku='${{ vars.AZURE_APP_SERVICE_PLAN_SKU }}' \
              databaseServerName='${{ vars.DATABASE_SERVER_NAME }}' \
              databaseName='${{ vars.DATABASE_NAME }}' \
              databaseAdminUsername='${{ vars.DATABASE_ADMIN_USERNAME }}' \
              databaseAdminPassword="$DATABASE_ADMIN_PASSWORD" \
              azurePostgresSku='${{ vars.AZURE_POSTGRES_SKU }}' \
              azurePostgresStorageSizeGB=${{ vars.AZURE_POSTGRES_STORAGE_SIZE_GB }} \
              postgresVersion='${{ vars.POSTGRES_VERSION }}' \
              azurePostgresBackupRetentionDays=${{ vars.AZURE_POSTGRES_BACKUP_RETENTION_DAYS }} \
              azureKeyVaultName='${{ vars.AZURE_KEY_VAULT_NAME }}'

  deploy:
    name: Deploy to ${{ inputs.environment || 'Production' }}
    runs-on: ubuntu-latest
    needs: validate
    environment: ${{ inputs.environment || 'Production' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure
        id: deploy
        env:
          DATABASE_ADMIN_PASSWORD: ${{ secrets.DATABASE_ADMIN_PASSWORD }}
        run: |
          echo "ðŸš€ Deploying infrastructure to ${{ vars.AZURE_ENVIRONMENT }} environment in ${{ vars.AZURE_LOCATION }}"

          az deployment sub create \
            --name "infrastructure-${{ vars.AZURE_ENVIRONMENT }}-$(date +%Y%m%d-%H%M%S)" \
            --location ${{ vars.AZURE_LOCATION }} \
            --template-file infrastructure/main.bicep \
            --parameters \
              azureResourceGroupName='${{ vars.AZURE_RESOURCE_GROUP_NAME }}' \
              azureLocation='${{ vars.AZURE_LOCATION }}' \
              azureEnvironment='${{ vars.AZURE_ENVIRONMENT }}' \
              azureAppServicePlanName='${{ vars.AZURE_APP_SERVICE_PLAN_NAME }}' \
              azureApiAppServiceName='${{ vars.AZURE_API_APP_SERVICE_NAME }}' \
              azureWebAppServiceName='${{ vars.AZURE_WEB_APP_SERVICE_NAME }}' \
              azureAppServicePlanSku='${{ vars.AZURE_APP_SERVICE_PLAN_SKU }}' \
              databaseServerName='${{ vars.DATABASE_SERVER_NAME }}' \
              databaseName='${{ vars.DATABASE_NAME }}' \
              databaseAdminUsername='${{ vars.DATABASE_ADMIN_USERNAME }}' \
              databaseAdminPassword="$DATABASE_ADMIN_PASSWORD" \
              azurePostgresSku='${{ vars.AZURE_POSTGRES_SKU }}' \
              azurePostgresStorageSizeGB=${{ vars.AZURE_POSTGRES_STORAGE_SIZE_GB }} \
              postgresVersion='${{ vars.POSTGRES_VERSION }}' \
              azurePostgresBackupRetentionDays=${{ vars.AZURE_POSTGRES_BACKUP_RETENTION_DAYS }} \
              azureKeyVaultName='${{ vars.AZURE_KEY_VAULT_NAME }}' \
            --output json > deployment-output.json

          echo "âœ… Infrastructure deployment completed"

      - name: Extract Deployment Outputs
        id: outputs
        run: |
          API_URL=$(cat deployment-output.json | jq -r '.properties.outputs.apiAppServiceUrl.value')
          WEB_URL=$(cat deployment-output.json | jq -r '.properties.outputs.webAppServiceUrl.value')
          DB_SERVER=$(cat deployment-output.json | jq -r '.properties.outputs.postgreSqlServerFqdn.value')
          DB_NAME=$(cat deployment-output.json | jq -r '.properties.outputs.postgreSqlDatabaseName.value')
          API_PRINCIPAL_ID=$(cat deployment-output.json | jq -r '.properties.outputs.apiAppServicePrincipalId.value')
          KV_NAME=$(cat deployment-output.json | jq -r '.properties.outputs.keyVaultName.value')
          KV_URI=$(cat deployment-output.json | jq -r '.properties.outputs.keyVaultUri.value')

          echo "api-url=$API_URL" >> $GITHUB_OUTPUT
          echo "web-url=$WEB_URL" >> $GITHUB_OUTPUT
          echo "db-server=$DB_SERVER" >> $GITHUB_OUTPUT
          echo "db-name=$DB_NAME" >> $GITHUB_OUTPUT
          echo "api-principal-id=$API_PRINCIPAL_ID" >> $GITHUB_OUTPUT
          echo "kv-name=$KV_NAME" >> $GITHUB_OUTPUT
          echo "kv-uri=$KV_URI" >> $GITHUB_OUTPUT

          echo "### ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ vars.AZURE_ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ vars.AZURE_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Web URL:** $WEB_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Database Server:** $DB_SERVER" >> $GITHUB_STEP_SUMMARY
          echo "**Database Name:** $DB_NAME" >> $GITHUB_STEP_SUMMARY
          echo "**Key Vault:** $KV_NAME" >> $GITHUB_STEP_SUMMARY

      - name: Configure Database Access for API Managed Identity
        run: |
          echo "ðŸ” Configuring Managed Identity access to PostgreSQL..."

          # Get the API App Service Managed Identity principal ID
          API_PRINCIPAL_ID="${{ steps.outputs.outputs.api-principal-id }}"
          API_APP_NAME="${{ vars.AZURE_API_APP_SERVICE_NAME }}-${{ vars.AZURE_LOCATION }}"

          # Add API's Managed Identity as Azure AD admin for PostgreSQL
          az postgres flexible-server ad-admin create \
            --resource-group ${{ vars.AZURE_RESOURCE_GROUP_NAME }} \
            --server-name ${{ vars.DATABASE_SERVER_NAME }}-${{ vars.AZURE_LOCATION }} \
            --display-name "$API_APP_NAME" \
            --object-id "$API_PRINCIPAL_ID" \
            --type ServicePrincipal || echo "AD admin already exists or failed to create"

          echo "âœ… Managed Identity configured for database access"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Database Access:** API Managed Identity configured" >> $GITHUB_STEP_SUMMARY

      - name: Add Secrets to Key Vault
        env:
          DATABASE_ADMIN_PASSWORD: ${{ secrets.DATABASE_ADMIN_PASSWORD }}
          GOOGLE_DOCS_CLIENT_EMAIL: ${{ secrets.GOOGLE_DOCS_CLIENT_EMAIL }}
          GOOGLE_DOCS_CLIENT_ID: ${{ secrets.GOOGLE_DOCS_CLIENT_ID }}
          GOOGLE_DOCS_CLIENT_X509_CERT_URL: ${{ secrets.GOOGLE_DOCS_CLIENT_X509_CERT_URL }}
          GOOGLE_DOCS_PRIVATE_KEY: ${{ secrets.GOOGLE_DOCS_PRIVATE_KEY }}
          GOOGLE_DOCS_PRIVATE_KEY_ID: ${{ secrets.GOOGLE_DOCS_PRIVATE_KEY_ID }}
        run: |
          echo "ðŸ” Adding secrets to Key Vault..."

          KV_NAME="${{ steps.outputs.outputs.kv-name }}"
          DB_SERVER="${{ steps.outputs.outputs.db-server }}"
          DB_NAME="${{ steps.outputs.outputs.db-name }}"

          # Get the currently authenticated service principal's object ID
          SP_OBJECT_ID=$(az ad signed-in-user show --query id -o tsv 2>/dev/null || az account show --query user.name -o tsv | xargs az ad sp show --id --query id -o tsv)

          # Grant temporary Key Vault Secrets Officer access to current service principal
          az role assignment create \
            --role "Key Vault Secrets Officer" \
            --assignee-object-id "$SP_OBJECT_ID" \
            --assignee-principal-type ServicePrincipal \
            --scope "/subscriptions/${{ vars.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ vars.AZURE_RESOURCE_GROUP_NAME }}/providers/Microsoft.KeyVault/vaults/$KV_NAME" \
            --output none || echo "Role assignment already exists or using access policy"

          # Wait a moment for RBAC to propagate
          sleep 10

          # Create connection string for API (Managed Identity - passwordless)
          CONNECTION_STRING="Host=$DB_SERVER;Database=$DB_NAME;Username=${{ vars.AZURE_API_APP_SERVICE_NAME }}-${{ vars.AZURE_LOCATION }};"

          # Add connection string to Key Vault
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "ConnectionStrings--bowlneba" \
            --value "$CONNECTION_STRING" \
            --output none

          # Add database admin password to Key Vault for manual access
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "DatabaseAdminPassword" \
            --value "$DATABASE_ADMIN_PASSWORD" \
            --output none

          # Add Google Docs credentials to Key Vault
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--ClientEmail" \
            --value "$GOOGLE_DOCS_CLIENT_EMAIL" \
            --output none

          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--ClientId" \
            --value "$GOOGLE_DOCS_CLIENT_ID" \
            --output none

          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--ClientX509CertUrl" \
            --value "$GOOGLE_DOCS_CLIENT_X509_CERT_URL" \
            --output none

          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--PrivateKey" \
            --value "$GOOGLE_DOCS_PRIVATE_KEY" \
            --output none

          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "GoogleDocs--Credentials--PrivateKeyId" \
            --value "$GOOGLE_DOCS_PRIVATE_KEY_ID" \
            --output none

          echo "âœ… Secrets added to Key Vault"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Vault Secrets:** ConnectionStrings--bowlneba, DatabaseAdminPassword, GoogleDocs credentials" >> $GITHUB_STEP_SUMMARY

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v5
        with:
          name: deployment-output-${{ vars.AZURE_ENVIRONMENT }}
          path: deployment-output.json
          retention-days: 30
